const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DKLdklYA.js","assets/index-BLBKdF3O.js","assets/index-DAEC-j9z.css"])))=>i.map(i=>d[i]);
import{_ as Z,u as ee,a as te,r,d as k,g as se,j as e,L as D,s as ae}from"./index-BLBKdF3O.js";const ne=["subtotal","total","tax","tip","balance","change","cash","card"],O=/(?:\$)?(\d+[\.,]\d{2})/g,A=s=>Number(s.replace(/,/g,"")),ie=s=>{const i=s.toLowerCase();return ne.some(l=>i.includes(l))},ce=s=>{const i=s.match(/^(\d+)\s*[xX]\s+/);if(i)return Number(i[1]);const l=s.match(/(\d+)\s*@/);if(l)return Number(l[1]);const m=s.match(/qty\s*(\d+)/i);return m?Number(m[1]):1};let I=null;const re=async()=>(I||(I=Z(()=>import("./index-DKLdklYA.js").then(s=>s.i),__vite__mapDeps([0,1,2]))),I),le=s=>{const i=[];return s.forEach((l,m)=>{const c=l.text.trim();if(!c||ie(c))return;const o=[...c.matchAll(O)].map(v=>v[1]);if(o.length===0)return;const h=o[o.length-1],y=o.length>1?o[o.length-2]:null,g=A(h);if(Number.isNaN(g))return;const f=ce(c),x=c.replace(O,"").replace(/^\s*\d+\s*[xX]\s+/,"").replace(/^\s*\d+\s*@\s*/,"").replace(/\bqty\s*\d+/i,"").replace(/\s+/g," ").trim();let N=f>0?Number((g/f).toFixed(2)):g;if(y&&f>1){const v=A(y);Number.isNaN(v)||(N=v)}x&&i.push({id:`${Date.now()}-${m}`,label:x,quantity:f,unit_price:N,total_price:g,confidence:l.confidence})}),i},oe=async(s,i)=>{const{default:l}=await re(),c=((await l.recognize(s,"eng",{logger:o=>{o.status==="recognizing text"&&typeof o.progress=="number"&&(i==null||i(o.progress))}})).data.lines??[]).map(o=>({text:o.text,confidence:o.confidence??0}));return le(c)},P=(s,i)=>new Intl.NumberFormat("en-US",{style:"currency",currency:i}).format(s),T=(s,i=0)=>Number.isFinite(s)?s:i,$=s=>s<60?{label:"Low confidence",className:"warn"}:s<80?{label:"Check",className:"mid"}:{label:"Good",className:"good"};function ue(){const{sessionId:s}=ee(),i=te(),l=r.useRef(null),m=r.useRef(null),[c,o]=r.useState(null),[h,y]=r.useState(null),[g,f]=r.useState(null),[x,N]=r.useState([]),[v,R]=r.useState(0),[b,w]=r.useState("idle"),[U,j]=r.useState(null),[C,W]=r.useState(!1),[F,G]=r.useState([]),[E,q]=r.useState(null),L="USD",B=!!(c&&b==="idle"),z=r.useMemo(()=>x.reduce((t,a)=>a.include?t+(Number(a.total_price)||0):t,0),[x]);r.useEffect(()=>{if(b!=="idle"||h)return;let t=!0;return(async()=>{try{const n=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1});if(!t){n.getTracks().forEach(d=>d.stop());return}o(n),l.current&&(l.current.srcObject=n,await l.current.play())}catch{j("Camera access blocked. Use file upload instead.")}})(),()=>{t=!1}},[b,h]),r.useEffect(()=>{if(!s)return;let t=!0;return k.getSession(s).then(a=>{!t||!a||W(a.status==="LOCKED")}).catch(()=>{}),()=>{t=!1}},[s]),r.useEffect(()=>{if(!s)return;let t=!0;return k.listGroups(s).then(a=>{if(!t)return;G(a);const n=se(s);n&&n!=="all"&&n!=="ungrouped"&&q(n)}).catch(()=>{}),()=>{t=!1}},[s]),r.useEffect(()=>()=>{c==null||c.getTracks().forEach(t=>t.stop())},[c]);const Q=async()=>{if(!l.current||!m.current)return;j(null);const t=l.current,a=m.current,n=t.videoWidth||1280,d=t.videoHeight||720;a.width=n,a.height=d;const u=a.getContext("2d");if(!u)return;u.drawImage(t,0,0,n,d);const p=a.toDataURL("image/jpeg",.9);c==null||c.getTracks().forEach(_=>_.stop()),o(null),y(p),f({width:n,height:d}),await M(p)},X=async t=>{var d;const a=(d=t.target.files)==null?void 0:d[0];if(!a)return;j(null);const n=new FileReader;n.onload=async()=>{if(typeof n.result!="string")return;const u=n.result,p=new Image;p.onload=async()=>{f({width:p.width,height:p.height}),y(u),await M(u)},p.src=u},n.readAsDataURL(a)},M=async t=>{w("scanning"),R(0);try{const a=await oe(t,n=>R(n));N(a.map(n=>({...n,include:!0}))),w("review")}catch{j("OCR failed. You can still add items manually."),w("review")}},Y=()=>{w("idle"),y(null),f(null),N([]),R(0)},S=(t,a)=>{N(n=>n.map(d=>{if(d.id!==t)return d;const u={...d,...a},p=T(Number(u.quantity),1),_=T(Number(u.unit_price),0),J=T(Number(u.total_price),_*p);return{...u,quantity:p,unit_price:_,total_price:J}}))},H=async()=>{if(s){if(C){j("Session is locked. You cannot add new receipts.");return}w("saving"),j(null);try{h&&g&&await k.addReceiptImage(s,{dataUrl:h,width:g.width,height:g.height});for(const t of x)!t.include||!t.label.trim()||await k.addItem(s,{label:t.label.trim(),quantity:Number(t.quantity)||1,unit_price:Number(t.unit_price)||0,total_price:Number(t.total_price)||0,group_id:E});i(`/${s}`)}catch{j("Unable to save items."),w("review")}}},K=()=>{N(t=>[...t,{id:`${Date.now()}-${t.length}`,label:"",quantity:1,unit_price:0,total_price:0,confidence:100,include:!0}])},V=t=>{N(a=>a.filter(n=>n.id!==t))};return s?e.jsxs("div",{className:"app-shell",children:[e.jsxs("div",{className:"brand",children:[e.jsx("span",{className:"brand-dot"}),"SplitScan"]}),e.jsxs("section",{className:"panel",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0},children:"Receipt Scanner"}),e.jsxs("p",{className:"caption",children:["Session ",s]})]}),e.jsx(D,{className:"button secondary",to:`/${s}`,children:"Back to workspace"})]}),e.jsxs("div",{style:{marginTop:12},children:[e.jsx("label",{className:"caption",style:{display:"block",marginBottom:6},children:"Assign to group"}),e.jsxs("select",{className:"select",value:E??"",onChange:t=>{const a=t.target.value||null;q(a),s&&ae(s,a??"ungrouped")},disabled:C,children:[e.jsx("option",{value:"",children:"Ungrouped"}),F.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),U&&e.jsx("div",{className:"notice",children:U}),C&&e.jsx("div",{className:"notice",children:"This session is locked. Scans can be reviewed but not saved."}),b==="idle"&&e.jsxs("section",{className:"panel",children:[e.jsx("h3",{className:"section-title",children:"Capture a receipt"}),e.jsxs("div",{className:"camera-frame",children:[e.jsx("video",{ref:l,playsInline:!0,muted:!0,className:"camera-video"}),!c&&e.jsx("div",{className:"camera-overlay",children:"Camera preview unavailable"})]}),e.jsxs("div",{style:{display:"flex",gap:12,flexWrap:"wrap",marginTop:16},children:[e.jsx("button",{className:"button primary",onClick:Q,disabled:!B||C,children:"Capture"}),e.jsxs("label",{className:"button secondary",style:{cursor:"pointer"},children:["Upload Image",e.jsx("input",{type:"file",accept:"image/*",onChange:X,hidden:!0,disabled:C})]})]}),e.jsx("p",{className:"caption",style:{marginTop:12},children:"Tip: keep the receipt flat and fill the frame for better OCR."})]}),b==="scanning"&&e.jsxs("section",{className:"panel",children:[e.jsx("h3",{className:"section-title",children:"Reading receipt"}),e.jsxs("p",{className:"caption",children:["OCR in progressâ€¦ ",(v*100).toFixed(0),"%"]}),e.jsx("div",{className:"progress",children:e.jsx("div",{className:"progress-bar",style:{width:`${Math.round(v*100)}%`}})})]}),b==="review"&&e.jsxs("section",{className:"panel",children:[e.jsx("h3",{className:"section-title",children:"Review parsed items"}),h&&e.jsx("div",{className:"receipt-preview",children:e.jsx("img",{src:h,alt:"Receipt preview"})}),e.jsx("div",{className:"list",style:{marginTop:16},children:x.length===0?e.jsx("p",{className:"caption",children:"No items detected. Add manually or try another photo."}):x.map(t=>e.jsxs("div",{className:"ocr-item",children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("input",{className:"input",value:t.label,onChange:a=>S(t.id,{label:a.target.value})}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:[e.jsx("span",{className:`badge ${$(t.confidence).className}`,children:$(t.confidence).label}),e.jsxs("label",{className:"toggle",children:[e.jsx("input",{type:"checkbox",checked:t.include,onChange:a=>S(t.id,{include:a.target.checked})}),"Include"]})]})]}),e.jsxs("div",{className:"ocr-fields",children:[e.jsxs("label",{className:"ocr-field",children:[e.jsx("span",{className:"field-label",children:"Quantity"}),e.jsx("input",{className:"input",type:"number",min:1,step:1,value:t.quantity,onChange:a=>{const n=Number(a.target.value);S(t.id,{quantity:n,total_price:n*t.unit_price})}})]}),e.jsxs("label",{className:"ocr-field",children:[e.jsx("span",{className:"field-label",children:"Unit price"}),e.jsx("input",{className:"input",type:"number",min:0,step:.01,value:t.unit_price,onChange:a=>{const n=Number(a.target.value);S(t.id,{unit_price:n,total_price:n*t.quantity})}})]}),e.jsxs("div",{className:"ocr-field",children:[e.jsx("span",{className:"field-label",children:"Total"}),e.jsx("div",{className:"ocr-readout",children:P(t.total_price,L)})]})]}),e.jsx("button",{className:"button secondary",onClick:()=>V(t.id),children:"Remove"})]},t.id))}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:16},children:[e.jsx("span",{className:"caption",children:"Parsed total"}),e.jsx("strong",{children:P(z,L)})]}),e.jsxs("div",{style:{display:"flex",gap:12,flexWrap:"wrap",marginTop:20},children:[e.jsx("button",{className:"button secondary",onClick:Y,children:"Retake"}),e.jsx("button",{className:"button secondary",onClick:K,children:"Add Manual Item"}),e.jsx("button",{className:"button primary",onClick:H,disabled:b==="saving"||C,children:b==="saving"?"Saving...":"Commit to Workspace"})]})]}),e.jsx("canvas",{ref:m,style:{display:"none"}})]}):e.jsxs("div",{className:"app-shell",children:[e.jsxs("div",{className:"brand",children:[e.jsx("span",{className:"brand-dot"}),"SplitScan"]}),e.jsxs("div",{className:"panel",children:[e.jsx("h2",{children:"Missing session"}),e.jsx("p",{children:"Return to the landing page to start a session."}),e.jsx(D,{className:"button secondary",to:"/",children:"Back to landing"})]})]})}export{ue as Scanner};
